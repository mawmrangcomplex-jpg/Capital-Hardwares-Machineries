<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CAPITAL HARDWARES &amp; MACHINERIES ‚Äî Public Catalog</title>
<meta name="description" content="Public product catalog (loads from JSONBin, read-only).">
<style>
  :root{ --bg:#080808; --card:#0f0f10; --text:#f5ecd8; --muted:#bfbfbf; --gold:#b98b27; --silver:#c6c6c6; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Roboto,system-ui;color:var(--text);background:var(--bg)}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{background:linear-gradient(90deg,var(--gold),var(--silver));color:#000;padding:18px 16px}
  nav{display:flex;gap:12px;justify-content:flex-end}
  nav a{color:#000;text-decoration:none;padding:8px 10px;border-radius:8px;font-weight:700}
  nav a.active{background:rgba(0,0,0,0.06)}
  .card{background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.01));border-radius:12px;padding:20px;margin-top:18px}
  .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:18px}
  .product{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.06));cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .product img{width:100%;height:140px;object-fit:cover;border-radius:8px}
  .meta{font-size:13px;color:var(--muted)}
  .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed rgba(255,255,255,0.03);border-radius:10px}
  .btn{background:var(--gold);color:#000;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;color:var(--silver);border:1px solid rgba(255,255,255,0.06)}
  .modal{position:fixed;inset:0;background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.75));display:none;align-items:center;justify-content:center;padding:20px}
  .modal.open{display:flex}
  .detail-img{width:100%;height:320px;object-fit:cover;border-radius:8px}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:20px">
    <div style="display:flex; gap:12px; align-items:center; cursor:pointer" onclick="navigate('home')">
      <img src="https://i.ibb.co/67bXFH76/LOGO.png" alt="logo" style="height:120px; width:auto; object-fit:contain">
      <div>
        <div style="font-size:20px; font-weight:800; color:#d4edec;">Capital Hardwares &amp; Machineries</div>
        <div class="meta">Quality Products ‚Ä¢ Display-only catalog</div>
      </div>
    </div>
    <nav>
      <a href="#home" data-route="home" class="active">Home</a>
      <a href="#products" data-route="products">Products</a>
      <a href="#contact" data-route="contact">Contact</a>
    </nav>
  </div>
</header>

<main class="container" id="app">
  <section id="view-home" class="card">
    <h1>Welcome to Capital Hardwares &amp; Machineries</h1>
    <p class="meta">Browse our product catalog. For inquiries, use the contact form.</p>
  </section>

  <section id="view-products" class="card" style="display:none">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div style="display:flex;gap:12px;align-items:center;flex:1">
        <input id="searchInput" class="search" placeholder="Search products by name or tag..." oninput="applyFilters()" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04)">
        <select id="categorySelect" style="width:200px" onchange="applyFilters()"><option value="">All categories</option></select>
        <select id="sortSelect" style="width:160px" onchange="applyFilters()">
          <option value="relevance">Sort: Relevance</option>
          <option value="name">Sort: Name (A‚ÄìZ)</option>
          <option value="newest">Sort: Newest</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="meta" id="resultsCount">0 products</div>
        <button class="btn" onclick="resetFilters()">Reset</button>
      </div>
    </div>

    <div id="productsGrid" class="products-grid" style="margin-top:16px">
      <div class="empty" id="emptyNotice">No products available.</div>
    </div>

    <div class="pagination" id="pagination" style="margin-top:18px"></div>
  </section>

  <section id="view-contact" class="card" style="display:none">
    <h2>Contact &amp; Inquiry</h2>
    <p class="meta">To inquire about a product, open the product detail and include the Product ID in your message.</p>
    <form onsubmit="submitContact(event)" style="display:grid;gap:10px;max-width:700px">
      <input id="name" placeholder="Your name" required>
      <input id="email" placeholder="Your email (optional)">
      <input id="whatsapp" placeholder="Your WhatsApp number">
      <input id="subject" placeholder="Product Name or Id Number">
      <textarea id="message" rows="6" placeholder="Message"></textarea>
      <div style="display:flex;gap:8px">
        <button class="btn" type="submit">Send Inquiry</button>
        <button class="btn secondary" type="button" onclick="resetContact()">Reset</button>
      </div>
    </form>
  </section>
</main>

<footer class="container" style="margin-top:18px">
  <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px">
    <div>¬© <strong>Capital Hardware &amp; Machineries</strong> Since 1991</div>
    <div class="meta">We Care For Our Customers</div>
  </div>
</footer>

<!-- modal -->
<div id="modal" class="modal" onclick="if(event.target.id==='modal') closeModal()">
  <div class="card" role="dialog" aria-modal="true" style="max-width:900px;width:100%;display:grid;grid-template-columns:1fr 360px;gap:18px;padding:18px;border-radius:12px">
    <div>
      <img id="detailImg" class="detail-img" src="" alt="Product image">
      <h2 id="detailTitle"></h2>
      <p id="detailDesc" class="meta"></p>
    </div>
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700;color:var(--gold)" id="detailPrice"></div>
        <div class="meta">üÜî Product ID: <span id="detailId"></span></div>
      </div>
      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">
      <p><strong>üìÇ Category:</strong> <span id="detailCat"></span></p>
      <p><strong>üè∑Ô∏è Tags:</strong> <span id="detailTags"></span></p>
      <div style="margin-top:12px">
        <button class="btn" onclick="contactAbout()">Inquire about this product</button>
        <button class="btn secondary" style="margin-left:8px" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* --- Config --- */
const STORAGE_KEY = 'cap_products';
const JSONBIN_BIN_ID = "69390c1bd0ea881f401ec9e3";
const JSONBIN_READ_KEY = "$2a$10$hE6kjo8yiOLXrXpyJTnbge7Smbigtc9/viX6ledsLb3vRaiD1WPt.";

let PRODUCTS_MAP = {};
let filteredList = [];
let currentPage = 1;
const perPage = 24;

/* --- Routing --- */
const routes = ['home','products','contact'];
function showView(view){
  routes.forEach(r=>{
    const el=document.getElementById('view-'+r);
    if(el) el.style.display = (r===view)?'block':'none';
  });
  document.querySelectorAll('nav a').forEach(a=>a.classList.toggle('active', a.dataset.route===view));
}
function handleRoute(){
  let page = location.hash.replace('#','') || 'home';
  if(page.startsWith('product-')){ showView('products'); setTimeout(()=> showProductFromHash(page),150); return; }
  if(!routes.includes(page)) page='home';
  showView(page);
  if(page==='products') setTimeout(()=> renderProductsPage(),50);
}
window.addEventListener('hashchange', handleRoute);

/* --- Cloud loader (with caching) --- */
async function loadProductsFromCloud() {
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
            headers: { "X-Access-Key": JSONBIN_READ_KEY }
        });
        if (!res.ok) throw new Error('Cloud fetch failed: '+res.status);
        const json = await res.json();
        PRODUCTS_MAP = json.record || {};
        // cache locally for faster fallback
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(PRODUCTS_MAP)); }catch(e){}
        return true;
    } catch (e) {
        console.warn('Cloud load failed, falling back to localStorage.', e);
        try{
            PRODUCTS_MAP = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        }catch(err){ PRODUCTS_MAP = {}; }
        return false;
    }
}

/* --- Helpers & rendering --- */
function getProductsArray(){ return Object.values(PRODUCTS_MAP).sort((a,b)=>(a.created||0)-(b.created||0)); }

function populateCategorySelect(categories){
  const sel = document.getElementById('categorySelect');
  sel.innerHTML = '<option value="">All categories</option>';
  Array.from(new Set(categories)).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
}

function renderProductsPage(){
  const arr = getProductsArray();
  filteredList = arr.slice();
  applyFilters(); // apply filters will call renderProductsPageInternal
}

function applyFilters(){
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const cat = document.getElementById('categorySelect').value;
  const sort = document.getElementById('sortSelect').value;
  const arr = getProductsArray();
  filteredList = arr.filter(p=>{
    const matchesQ = q? ((p.title||'').toLowerCase().includes(q) || (p.tags||[]).join(' ').toLowerCase().includes(q)) : true;
    const matchesCat = cat? p.category===cat : true;
    return matchesQ && matchesCat;
  });
  if(sort==='name') filteredList.sort((a,b)=>(a.title||'').localeCompare(b.title||''));
  else if(sort==='newest') filteredList.sort((a,b)=>(b.created||0)-(a.created||0));
  currentPage = 1;
  renderProductsPageInternal();
}

function renderProductsPageInternal(){
  const grid = document.getElementById('productsGrid');
  const empty = document.getElementById('emptyNotice');
  const arr = filteredList;
  if(arr.length===0){
    grid.innerHTML=''; grid.appendChild(empty); document.getElementById('resultsCount').textContent='0 products'; document.getElementById('pagination').innerHTML=''; populateCategorySelect([]); return;
  }
  // ensure empty notice removed
  if(empty.parentElement) empty.parentElement.removeChild(empty);
  // populate categories
  populateCategorySelect(getProductsArray().map(p=>p.category).filter(Boolean));
  grid.innerHTML='';
  const start=(currentPage-1)*perPage;
  const pageItems = arr.slice(start,start+perPage);
  pageItems.forEach(p=>{
    const el=document.createElement('div'); el.className='product card';
    el.innerHTML = `<img loading="lazy" src="${p.image||('https://picsum.photos/seed/'+p.id+'/800/600')}" alt="${escapeHtml(p.title||'')}"><h3>${escapeHtml(p.title||'(no title)')}</h3><div class="meta">${escapeHtml(p.category||'')} ‚Ä¢ ${escapeHtml(p.price||'')}</div>`;
    el.onclick = ()=> openProduct(p.id);
    grid.appendChild(el);
  });
  document.getElementById('resultsCount').textContent = `${arr.length.toLocaleString()} products`;
  renderPagination();
}

function renderPagination(){
  const container = document.getElementById('pagination');
  const total = Math.max(1, Math.ceil(filteredList.length / perPage));
  container.innerHTML='';
  const prev = document.createElement('button'); prev.className='btn secondary'; prev.textContent='Prev'; prev.disabled = currentPage===1; prev.onclick = ()=>{ currentPage--; renderProductsPageInternal(); };
  const next = document.createElement('button'); next.className='btn secondary'; next.textContent='Next'; next.disabled = currentPage===total; next.onclick = ()=>{ currentPage++; renderProductsPageInternal(); };
  container.appendChild(prev);
  const startPage = Math.max(1, currentPage-2); const endPage = Math.min(total, currentPage+2);
  for(let i=startPage;i<=endPage;i++){ const b=document.createElement('button'); b.className='btn secondary'; b.textContent=i; if(i===currentPage) b.style.fontWeight='700'; b.onclick = ()=>{ currentPage=i; renderProductsPageInternal(); }; container.appendChild(b); }
  container.appendChild(next);
}

/* --- Product modal --- */
function openProduct(id){
  const p = PRODUCTS_MAP[id];
  if(!p) return alert('Product not found.');
  const productImage = p.image || p.img || p.imgUrl || p.url || 'https://i.ibb.co/7jmqfBB/no-image.jpg';
  document.getElementById('detailImg').src = productImage;
  document.getElementById('detailTitle').textContent = p.title || '';
  document.getElementById('detailDesc').textContent = p.description || '';
  document.getElementById('detailPrice').textContent = p.price || '';
  document.getElementById('detailId').textContent = p.id || '';
  document.getElementById('detailCat').textContent = p.category || '';
  document.getElementById('detailTags').textContent = (p.tags||[]).join(', ');
  document.getElementById('modal').classList.add('open');
  location.hash = 'product-'+p.id;
}
function closeModal(){ document.getElementById('modal').classList.remove('open'); if(location.hash.startsWith('#product-')) location.hash='products'; }
function showProductFromHash(hash){ const id = hash.split('-')[1]; if(id) openProduct(id); }

/* --- Contact --- */
function contactAbout(){ const id=document.getElementById('detailId').textContent; location.hash='contact'; setTimeout(()=>{ document.getElementById('subject').value=`Product inquiry: ID #${id} ‚Äî ${document.getElementById('detailTitle').textContent}`; document.getElementById('message').focus(); },200); }
function submitContact(e){
  e.preventDefault();
  const payload = {
    id: Date.now().toString(),
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim(),
    whatsapp: document.getElementById('whatsapp').value.trim(),
    subject: document.getElementById('subject').value.trim(),
    message: document.getElementById('message').value.trim(),
    date: new Date().toLocaleString()
  };
  let inquiries = JSON.parse(localStorage.getItem('cap_inquiries') || '[]');
  inquiries.push(payload);
  localStorage.setItem('cap_inquiries', JSON.stringify(inquiries));
  alert('Inquiry submitted successfully!');
  resetContact();
}
function resetContact(){ document.getElementById('name').value=''; document.getElementById('email').value=''; document.getElementById('whatsapp').value=''; document.getElementById('subject').value=''; document.getElementById('message').value=''; }

/* --- Utilities --- */
function escapeHtml(unsafe) {
    if(!unsafe && unsafe !== 0) return '';
    return String(unsafe).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}
function resetFilters(){ document.getElementById('searchInput').value=''; document.getElementById('categorySelect').value=''; document.getElementById('sortSelect').value='relevance'; applyFilters(); }

/* --- Init on load --- */
window.addEventListener('load', async () => {
    await loadProductsFromCloud();
    handleRoute();
});
</script>
</body>
</html>
